#!/bin/bash
# status_hub.10s.sh ‚Äî Clean sharable template version
export PATH="/opt/homebrew/opt/coreutils/libexec/gnubin:$PATH"

# --- CONFIG ---
START_DATE="2024-01-01"  # Date you want to count uptime from
MOOD_LIST=("You got this üí™" "Focus. Breathe. Win. üßò‚Äç‚ôÇÔ∏è" "Chaos is a ladder üî•" "Today‚Äôs vibe: coffee ‚òï + code" "Eat. Code. Sleep. Repeat." "Be the bug you wish to see in prod üêû")

# --- PERSONAL EVENTS (replace with yours) ---
EVENT_1_DATE="2023-08-01"
EVENT_2_DATE="2022-09-01"
EVENT_3_START="2022-10-01"
EVENT_3_END="2023-10-01"
EVENT_4_DATE="2023-10-01"
DEVICE_PURCHASE_DATE="2025-03-01"
PROJECT_START_DATE="2023-06-01"
TODAY=$(date +%F)

# --- DATE DIFF FUNCTION ---
date_diff_human() {
  local start_date="$1"
  local end_date="$2"
  
  # Parse dates (format YYYY-MM-DD)
  local sy="${start_date%-*-*}"
  local sm="${start_date#*-}"; sm="${sm%-*}"
  local sd="${start_date##*-}"
  
  local ey="${end_date%-*-*}"
  local em="${end_date#*-}"; em="${em%-*}"
  local ed="${end_date##*-}"
  
  # Remove leading zeros for calculations
  sy=$((10#$sy))
  sm=$((10#$sm))
  sd=$((10#$sd))
  ey=$((10#$ey))
  em=$((10#$em))
  ed=$((10#$ed))
  
  local y=$((ey - sy))
  local m=$((em - sm))
  local d=$((ed - sd))
  
  if (( d < 0 )); then
    m=$((m - 1))
    d=$((d + 30))  # Simplified for template
  fi
  
  if (( m < 0 )); then
    y=$((y - 1))
    m=$((m + 12))
  fi
  
  echo "${y}y ${m}m ${d}d"
}

# --- UPTIME ---
NOW=$(date +%s)
# Cross-platform date conversion
if command -v gdate >/dev/null 2>&1; then
  START=$(gdate -d "$START_DATE" +%s)
else
  # BSD date (macOS)
  START=$(date -j -f "%Y-%m-%d" "$START_DATE" +%s 2>/dev/null || echo $NOW)
fi
DAYS=$(((NOW - START) / 86400))
MONTHS=$((DAYS / 30))
REMAINDER=$((DAYS % 30))
UPTIME="Ô£ø ${MONTHS}m ${REMAINDER}d"

# --- BATTERY ---
cycle_count=$(system_profiler SPPowerDataType | awk -F': ' '/Cycle Count/ {print $2; exit}')
if ((cycle_count < 300)); then battery_icon="üîã"
elif ((cycle_count < 700)); then battery_icon="üü°"
else battery_icon="üî¥"; fi

# --- DOCKER ---
if docker info &>/dev/null; then
  running_containers=$(docker ps --filter "status=running" --format '{{.Names}}' | wc -l | tr -d ' ')
  docker_summary="üê≥ $running_containers"
else
  running_containers="0"
  docker_summary="‚ùå Docker Not Running"
fi

# --- MOOD ---
mood_index=$(( $(date +%j) % ${#MOOD_LIST[@]} ))
mood="üåà ${MOOD_LIST[$mood_index]}"

# --- SWAP USAGE ---
swap_stats=$(sysctl -n vm.swapusage)
swap_total=$(echo "$swap_stats" | awk '{print $3}')
swap_used=$(echo "$swap_stats" | awk '{print $6}')
swap="üíæ Swap: ${swap_used} / ${swap_total}"

# --- WEATHER ---
# Example coordinates: New York City (replace with your location)
weather_url="https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=40.7128&lon=-74.0060"
user_agent="StatusHub-WeatherScript/1.0 (contact@yoursite.com)"
temp=$(curl -s -H "User-Agent: $user_agent" "$weather_url" \
  | jq -r '.properties.timeseries[0].data.instant.details.air_temperature')
weather="üå§Ô∏è Weather: ${temp:-‚ùå}¬∞C"

# --- CURRENCY ---
CACHE_DIR="$HOME/.cache/swiftbar"
mkdir -p "$CACHE_DIR"
currency_file="$CACHE_DIR/currency.json"
currency_url="https://open.er-api.com/v6/latest/USD"
# Cross-platform file age check
should_update=true
if [[ -f "$currency_file" ]]; then
  # Check if file is newer than 5 minutes
  if [[ $(find "$currency_file" -mmin -5 2>/dev/null) ]]; then
    should_update=false
  fi
fi
if [[ "$should_update" == "true" ]]; then
  curl -s "$currency_url" > "$currency_file"
fi
usd_rub=$(jq -r '.rates.RUB' "$currency_file")
usd_eur=$(jq -r '.rates.EUR' "$currency_file")
eur_rub=$(awk "BEGIN { printf \"%.4f\", $usd_rub / $usd_eur }")

# --- CUSTOM TIMER (Example: eye drops) ---
schedule=(660 900 1140 1380 180)
now_min=$((10#$(date +%H)*60 + 10#$(date +%M)))
for t in "${schedule[@]}"; do
  if (( now_min < t || (now_min >= 1380 && t == 180) )); then
    next=$t; break
  fi
done
[[ -z "$next" ]] && next=${schedule[0]} && delta=$((1440 - now_min + next)) || delta=$((next - now_min))
hours_left=$((delta / 60))
mins_left=$((delta % 60))
drop_timer="‚è∞ Next reminder: $(printf '%02d:%02d' $hours_left $mins_left)"

# --- OUTPUT ---
echo "$UPTIME $battery_icon ‚Üª ${cycle_count} $docker_summary"
echo "---"
echo "$drop_timer | bash=/bin/true terminal=false"
echo "$weather | bash=/bin/true terminal=false"
echo "üí± CURRENCY RATES: | bash=/bin/true terminal=false"
echo "‚Ä¢ üíµ 1 USD = ${usd_rub:-‚ùå} RUB | bash=/bin/true terminal=false"
echo "‚Ä¢ üí∂ 1 USD = ${usd_eur:-‚ùå} EUR | bash=/bin/true terminal=false"
echo "‚Ä¢ üí∂ 1 EUR ‚âà ${eur_rub:-‚ùå} RUB | bash=/bin/true terminal=false"
echo "---"
echo "Docker: $running_containers containers | bash=/bin/true terminal=false"
echo "Battery: $cycle_count cycles | bash=/bin/true terminal=false"
echo "$swap | bash=/bin/true terminal=false"
echo "Mac uptime: $DAYS days since $START_DATE | bash=/bin/true terminal=false"
echo "---"
echo "üìå Event 1 since $EVENT_1_DATE: $(date_diff_human "$EVENT_1_DATE" "$TODAY") | bash=/bin/true terminal=false"
echo "üìå Event 2 since $EVENT_2_DATE: $(date_diff_human "$EVENT_2_DATE" "$TODAY") | bash=/bin/true terminal=false"
echo "üìå Period: $(date_diff_human "$EVENT_3_START" "$EVENT_3_END") | bash=/bin/true terminal=false"
echo "üìå Location since $EVENT_4_DATE: $(date_diff_human "$EVENT_4_DATE" "$TODAY") | bash=/bin/true terminal=false"
echo "üì± Device since $DEVICE_PURCHASE_DATE: $(date_diff_human "$DEVICE_PURCHASE_DATE" "$TODAY") | bash=/bin/true terminal=false"
echo "üß¢ Project since $PROJECT_START_DATE: $(date_diff_human "$PROJECT_START_DATE" "$TODAY") | bash=/bin/true terminal=false"
echo "$mood | bash=/bin/true terminal=false"
